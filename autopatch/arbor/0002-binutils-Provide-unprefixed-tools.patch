From 63b3f46e3ff37c26b74a2b7d308f3e92f7f7d0a8 Mon Sep 17 00:00:00 2001
From: Quentin Glidic <sardemff7+git@sardemff7.net>
Date: Tue, 15 Mar 2016 16:37:06 +0100
Subject: [PATCH] binutils: Provide unprefixed tools

Change-Id: I019abdfa44e8ee4d089cdf2f0b931566c1f3f7e3
Signed-off-by: Quentin Glidic <sardemff7+git@sardemff7.net>
Signed-off-by: Marc-Antoine Perennou <keruspe@exherbo.org>
---
 ...25.1-r5.exheres-0 => binutils-2.25.1-r6.exheres-0} |  0
 packages/sys-devel/binutils/binutils.exlib            | 19 ++++++++++++++++---
 2 files changed, 16 insertions(+), 3 deletions(-)
 rename packages/sys-devel/binutils/{binutils-2.25.1-r5.exheres-0 => binutils-2.25.1-r6.exheres-0} (100%)

diff --git a/packages/sys-devel/binutils/binutils-2.25.1-r5.exheres-0 b/packages/sys-devel/binutils/binutils-2.25.1-r6.exheres-0
similarity index 100%
rename from packages/sys-devel/binutils/binutils-2.25.1-r5.exheres-0
rename to packages/sys-devel/binutils/binutils-2.25.1-r6.exheres-0
diff --git a/packages/sys-devel/binutils/binutils.exlib b/packages/sys-devel/binutils/binutils.exlib
index a57ee10..e1c9633 100644
--- a/packages/sys-devel/binutils/binutils.exlib
+++ b/packages/sys-devel/binutils/binutils.exlib
@@ -160,7 +160,7 @@ binutils_src_install() {
     for target in ${CROSS_COMPILE_TARGETS} ; do
         local m symbols
         # eclectic managed files
-        local em=( /usr/${host}/bin/${target}-ld /usr/${host}/${target}/bin/ld )
+        local em=( /usr/${host}/bin/${target}-ld /usr/${host}/bin/ld /usr/${host}/${target}/bin/ld "${BANNEDDIR}"/ld )
 
         if option !targets:${target} ; then
             echo "    Cross-Compile Target: ${target} (disabled)"
@@ -180,13 +180,20 @@ binutils_src_install() {
             local name=${f##*/}
 
             dosym ..${t} /usr/${host}/bin/${target}-${name}
+
+            # install unprefixed tools for the native target
+            if [[ ${target} == ${host} ]]; then
+                dosym ${target}-${name} /usr/${host}/bin/${name}
+                dobanned ${name}
+            fi
         done
 
-        # alternatives setup
+        # provided by alternatives
         for m in "${em[@]}" ; do
             edo rm -f "${IMAGE}${m}"
         done
 
+        # alternatives setup
         for provider in bfd gold ; do
             local priority=
             local alternatives=()
@@ -198,10 +205,16 @@ binutils_src_install() {
 
             alternatives=( ld ${provider} ${priority} )
             for m in "${em[@]}" ; do
-                alternatives+=( "${m}" "/usr/${host}/${target}/bin/ld.${provider}" )
+                alternatives+=( "${m}" ld.${provider} )
             done
             alternatives_for "${alternatives[@]}"
         done
     done
+
+    # install unprefixed man pages
+    for f in "${IMAGE}"/usr/share/man/man1/${host}-*.1; do
+        t=${f##${IMAGE}}
+        dosym ${f##*/} ${t/${host}-/}
+    done
 }
 
-- 
2.8.2

